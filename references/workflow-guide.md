# 变更规模与流程匹配指南

## 核心原则

**Spec-First 是推荐的工作方式**，Vibe Coding 是在已发生情况下的补救措施。

根据变更规模选择合适的流程，既保证文档的一致性，又不过度增加开发负担。

---

## 变更规模分层

### 📊 快速对照表

| 变更规模 | 示例 | 推荐流程 | Spec 更新 | ADR |
|----------|------|----------|-----------|-----|
| **微小修复** | 修复 typo、简单 bug | 直接改 → 提交 | ❌ 不需要 | ❌ |
| **小型 Bug** | 修复逻辑错误、边界条件 | 直接改 → 更新 Change Log | ⚡ 仅 Change Log | ❌ |
| **中型功能** | 新增 API、修改数据结构 | 先更新 Spec → 再实现 | ✅ 完整更新 | ⚡ 可选 |
| **大型重构** | 架构调整、核心模块重写 | 先写 ADR → 更新 Spec → 再实现 | ✅ 完整更新 | ✅ 必须 |

---

## 详细分层说明

### Level 0: 微小修复（不需要更新 Spec）

**适用范围**：
- 修复拼写错误 (typo)
- 调整日志输出格式
- 更新/添加代码注释
- 修复明显的语法错误
- 调整代码格式/缩进
- 更新开发环境配置

**流程**：
```
直接修改 → git commit → 完成
```

**判断标准**：
- 不影响任何功能行为
- 不涉及业务逻辑
- 改动可在 1 分钟内完成审查

---

### Level 1: 小型 Bug 修复（仅更新 Change Log）

**适用范围**：
- 修复空指针/空值异常
- 修复边界条件处理
- 修复数据格式转换问题
- 修复配置参数错误
- 修复简单的逻辑错误
- 修复 UI 显示问题

**流程**：
```
1. 直接修改代码
2. 在 spec.md 的 Change Log 中添加一行记录
3. git commit
```

**Change Log 格式**：
```markdown
| 日期 | 类型 | 变更内容 | 影响需求 |
|------|------|----------|----------|
| YYYY-MM-DD | BUG_FIX | {简要描述} | 无 |
```

**判断标准**：
- 修复的是现有功能的错误
- 修复后行为符合原有设计预期
- 不需要改变需求描述

---

### Level 2: 中型功能改动（需要先更新 Spec）

**适用范围**：
- 新增 API 端点
- 修改数据模型字段
- 调整业务逻辑流程
- 新增配置选项
- 添加新功能特性
- 修改默认行为

**流程**（标准 Spec-First）：
```
1. 【先更新 Spec】
   - 修改 spec.md 中的需求描述
   - 如涉及 API，更新 api.md
   - 如涉及数据，更新 data-model.md

2. 【更新任务】
   - 在 tasks.md 中添加/更新任务

3. 【实现代码】
   - 按照 Spec 实现功能

4. 【记录 Change Log】
   - 标注类型和影响的需求编号
```

**判断标准**：
- 会改变系统的外部行为
- 需要修改接口契约
- 影响其他模块的集成

**ADR 建议**：可选，当存在多种实现方案时创建

---

### Level 3: 大型架构重构（需要 ADR + 完整 Spec）

**适用范围**：
- 更换核心依赖库
- 重构模块架构
- 引入新的设计模式
- 大规模性能优化
- 数据库 Schema 迁移
- 跨模块重构

**流程**（完整决策流程）：
```
1. 【撰写 ADR】
   - 记录决策背景和问题
   - 列出备选方案及优缺点
   - 说明选择理由
   - 评估风险和影响

2. 【ADR 评审】
   - 团队讨论确认方案
   - 标注 ADR 状态为 Accepted

3. 【更新 Spec】
   - 根据 ADR 更新所有相关文档
   - 在 spec.md 中引用 ADR

4. 【拆分任务】
   - 在 tasks.md 中细化任务
   - 标注依赖关系

5. 【逐步实现】
   - 按任务顺序实现
   - 每完成一个任务更新状态

6. 【记录 Change Log】
   - 关联 ADR 编号
```

**判断标准**：
- 决策不可轻易逆转
- 影响多个模块
- 涉及技术栈选择
- 需要团队共识

---

## 决策流程图

```
                         代码变更
                            │
                            ▼
                    ┌───────────────┐
                    │ 是否影响功能  │
                    │ 行为或接口？  │
                    └───────┬───────┘
                            │
              ┌─────────────┼─────────────┐
              │             │             │
             否            是             │
              │             │             │
              ▼             ▼             │
        ┌─────────┐   ┌─────────────┐     │
        │是否修复 │   │  变更规模   │     │
        │  Bug？  │   │   多大？    │     │
        └────┬────┘   └──────┬──────┘     │
             │               │            │
        ┌────┴────┐    ┌─────┴─────┐      │
        │         │    │           │      │
       是        否   中型        大型    │
        │         │    │           │      │
        ▼         ▼    ▼           ▼      │
    ┌───────┐ ┌─────┐ ┌────────┐ ┌────────┴──┐
    │Level 1│ │ L0  │ │Level 2 │ │  Level 3  │
    │Change │ │ 无  │ │更新Spec│ │ADR + Spec │
    │ Log   │ │ 需  │ │  先    │ │   完整    │
    │  仅   │ │ 求  │ │        │ │   流程    │
    └───────┘ └─────┘ └────────┘ └───────────┘
```

---

## 逆向补救：Vibe Coding 后的处理

如果已经发生了 Vibe Coding（先改代码后补文档），按以下流程补救：

### Step 1: 评估变更级别

使用上述分层标准判断本次变更属于哪个级别。

### Step 2: 按级别补充文档

| 级别 | 补救措施 |
|------|----------|
| Level 0 | 无需补救 |
| Level 1 | 补充 Change Log |
| Level 2 | 使用本 Skill 同步 Spec，标注"后补" |
| Level 3 | 补写 ADR，完整更新 Spec，标注"后补" |

### Step 3: 标注"后补"标记

在 Change Log 中使用 `[VIBE]` 标记后补的变更：

```markdown
| 日期 | 类型 | 变更内容 | 影响需求 |
|------|------|----------|----------|
| 2026-01-30 | [VIBE] BEHAVIOR_CHANGE | 调整分块阈值逻辑 | REQ-002-03 |
```

---

## 特殊场景处理

### 紧急修复 (Hotfix)

生产环境紧急问题可以跳过 Spec-First：
```
1. 直接修复 → 部署
2. 事后补充 Change Log，标注 [HOTFIX]
3. 如涉及 Level 2+，补充完整文档
```

### 探索性开发

原型验证阶段可以 Vibe Coding：
```
1. 快速实现原型
2. 确认方案后，补写 Spec
3. 基于 Spec 重构代码
```

### 外部依赖升级

依赖库版本升级：
```
- 小版本升级 (patch): Level 0
- 中版本升级 (minor): Level 1
- 大版本升级 (major): Level 2 或 Level 3
```

---

## 检查清单

### 提交前自查

- [ ] 本次变更属于哪个级别？
- [ ] 是否按级别要求更新了文档？
- [ ] Change Log 是否已记录？
- [ ] 如果是 Level 3，ADR 是否已创建并被接受？

### 代码审查关注点

- [ ] 变更级别判断是否准确？
- [ ] 文档更新是否与代码一致？
- [ ] 如有 Vibe Coding，是否已正确标注？
